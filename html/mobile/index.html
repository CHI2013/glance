<!DOCTYPE html> 
<html> 
  <head> 
  <title>CHI'13 Interactive Schedule</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />
  <link rel="stylesheet" href="css/ios.css" />
  <link rel="stylesheet" href="css/mobile.css" />
  <script src="js/jquery-1.8.3.min.js"></script>
  <script src="js/NativeBridge.js"></script>
  <script src="js/jquery.mobile-1.3.0.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <!--<script src="../lib/phone.js"></script> -->
</head> 
<body> 

<div data-role="page" id="home" data-add-back-btn="true">
  <div data-role="header" data-position="fixed">
      <h1>iSchedule</h1>
  </div>
  <div data-role="content"> 

      <h3> Welcome to CHI'13 interactive schedule. </h3>
      <p> Here you can interact with the large displays found through the conference and discover interesting events and add them to your schedule.</p>
      <p> You found one of the large displays? Great! Now, <a href="#screens" data-transition="slide">which one is it?</a></p>
  </div>
</div>

<div data-role="page" id="screens" data-add-back-btn="true" data-back-btn-text="Instructions">
 <script>

</script>
  <div data-role="header" data-position="fixed">
    <h1>iSchedule</h1>
  </div>
 
  <div data-role="content"> 
    <h3> The label at the top says...</h3>
    <ul  id="screen_list" data-role="listview" data-filter="false">
      <li><h3><a href="#options?screen=1" data-transition="slide">Screen 1</a></h3></li>
      <li><h3><a href="#options?screen=2" data-transition="slide">Screen 2</a></h3></li>
      <li><h3><a href="#options?screen=3" data-transition="slide">Screen 3</a></h3></li>
      <li><h3><a href="#options?screen=4" data-transition="slide">Screen 4</a></h3></li>
      <li><h3><a href="#options?screen=5" data-transition="slide">Screen 5</a></h3></li>
      <li><h3><a href="#options?screen=6" data-transition="slide">Screen 6</a></h3></li>
    </ul>
  </div>
</div>


<div data-role="page" id="options" data-add-back-btn="true" data-back-btn-text="Screens">
  <div data-role="header" data-position="fixed" >
    <h1>iSchedule</h1>
  </div>
  
  <div data-role="content"> 
    <h3> What are you up to?</h3>
    <p> I'm interested in a video showing on the screen and I would like to <a href="#tiles" data-transition="slide">add it to my schedule. </a> </p>
    <p> I want to show stuff relevant to my interest on the big display. I want to <a href="#search" data-transition="slide">search. </a></p>
  </div>
 
</div>

<div data-role="page" id="search"  data-add-back-btn="true"  data-back-btn-text="Back">
  <script>
  $(document).on("pageinit","#search", function(){

    var result = "";
    $( document ).on( "listviewbeforefilter", '#autocomplete', function ( e, data ) {
        var $ul = $( this ),
            $input = $( data.input ),
            value = $input.val(),
            html = "";
        $ul.html( "" );
        if ( value && value.length > 2 ) {
            $ul.html( "<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>" );
            $ul.listview( "refresh" );
            $.ajax({
                url: "http://92.243.30.77:8000/autocompletelist",
                dataType: "jsonp",
                crossDomain: true,
                data: {
                    substring: $input.val()
                }
            })
            .then( function ( response ) {
              console.log(response);
              var temp = [];
                $.each( response, function ( i, val ) {
                    html += "<li  class='result' data-source=" + val.source + ">" + i + "<span class='ui-li-count'>" + val.submissions.length + "</span></li>";
                });
                console.log(temp);
                $ul.html( html );
                $ul.listview( "refresh" );
                $ul.trigger( "updatelayout");
            });
        }
    });

    $("#autocomplete").listview({
      autodividers: true,
      autodividersSelector: function ( li ) {
          var out = $(li).attr('data-source');
          return out;
      }
    });


    $("#autocomplete").delegate('.result', 'vclick', function(){
      $(this).toggleClass("selected");
      result = "";
      if($(".selected").exists()){
         $("#post").css("visibility","visible");
         var $selected = $(".selected");
         for(var i = 0; i< $selected.length; i++){
          var temp = $selected[i].innerText;
          result += temp.substring(0, temp.length - 1) + " ";
         }
      }
      else{
         $("#post").css("visibility","hidden");
      }
    });

    $('#post').on("click", function(){
      $.mobile.changePage("#tiles", "slide", true, true);
    })


    $.fn.exists = function () {
      return this.length !== 0;
    }
  });
  </script>
  <div data-role="header" data-position="fixed">
    <h1>Search</h1>
    <a id="post" class=" ui-btn-right invisible" href="#tiles" data-icon="check" data-theme="b">Post</a>
  </div>
 
  <div data-role="content"> 
    <ul id='autocomplete' data-role='listview' data-inset='false' data-filter='true' data-filter-placeholder='Search everything'  data-autodividers="true"> 
    </ul>
  </div>
</div>

<div data-role="page" id="tiles"  data-add-back-btn="true"  data-back-btn-text="Back">
 
  <script>
    $(document).on("pageinit","#tiles", function(){
    var glanceHost = "92.243.30.77:8000";

     
      // $.getJSON('http://'+glanceHost+'/'+'tiles'+'?callback=?'  , function(data) {
      //     console.log(data);
      // });

    var socket = io.connect("http://"+window.location.hostname, {port: 8000});
    //var socket = io.connect("http://92.243.30.77", {port: 8000});
    
    //visual tiles
    var tiles = $(".tile");
    var filters =[];
    //logical tiles
    var tiles2 = [];

    //infamous global variables
    var onsync = true;
    var missed =[];

    var globalId = "";
    var globalSubId = 0;

    var tagTileId = ""

    //Logical structure for each tile data
    function Tile (id){
      this.id = id;
      this.text = "";
      this.total = 0;
      this.current = 0;
      this.submissionId = 0;
      this.submissions = {};
      this.isInSchedule = false;
    };

    Tile.prototype.updateCurrent = function(current){
      this.current = current;
    };

    Tile.prototype.getCurrent = function(){
      return this.current;
    };

    Tile.prototype.updateTotal = function(total){
      this.total = total;
    };
    Tile.prototype.getTotal = function(){
      return this.total;
    };

    Tile.prototype.reset = function(){
      this.text = "Select a keyword";
      this.total = 0;
      this.current = 0;
      this.submissionId = 0;
      this.submissions = {};
    };

    //Creates 7 Tile objects
    function createTiles(){
      var ids = ["A","B","C","D","E","F","G","H"];
      for (var i=0; i< ids.length; i++){
        var tile = new Tile(ids[i]);
        tiles2.push(tile);
      }
    };

    //Called at load
    createTiles();

    //Load existing JSON data from /tiles and assign it to logical tiles
    function loadData(){
      $.get('/tiles', function(data){
        console.log(data);
        for(id in data){
          if(data[id].type == "filter" && data[id].hasOwnProperty("filter"))
          {
            var filter = data[id];
            for(var i = 0; i<tiles2.length;i++)
            { 
              var tile = tiles2[i];
              if(tile.id === filter.filter.tileId)
              { 
                tile.total = filter.total;
                tile.submissions = filter.filter.submissions;

                if (tile.total > 0){
                tile.text = tile.submissions[tile.current].title;
                tile.submissionId = tile.submissions[tile.current]._id;
                tile.isInSchedule = NativeBridge.call('isInSchedule',mapId(tile.submissionId),thisiscallback);                  
                }
              }
            }
          }
        }

        showSubmissions();
      });
    }

    //Load logical tiles' data into visual tiles
    function showSubmissions(){
      for(var i = 0; i< tiles2.length; i++)
      {
        var tile = tiles2[i];
        if(tile.total > 0 && tile.id == tiles[i].getAttribute(
          "id"))
        {
        //tiles is the visual tiles, tiles2 are the logical tiles
        tiles[i].innerHTML = tile.text;
        tiles[i].setAttribute("submissionId", tile.submissionId);
        tiles[i].setAttribute("total", tile.total);
        tiles[i].setAttribute("isInSchedule", tile.isInSchedule);

        if(tile.isInSchedule){
          tiles[i].innerHTML += " In Schedule";
        }
        else{
          tiles[i].innerHTML += " Not In Schedule";
        }
        }
      }
    };

  //Update logical tiles then visual tiles
    function updateSubmissions(tileId, talkId){

      console.log("ID: " + tileId  + "  " + "current" + talkId);
      //loop used to find the tile with the right id
      for(var i = 0; i< tiles2.length; i++)
      {

        var tile = tiles2[i];
        if(tile.id == tileId)
        {
        talkId = talkId % tile.total;
        //assign new text and id to logical tile
        tile.text= tile.submissions[talkId].title;
        tile.submissionId = tile.submissions[tile.current]._id;
        //assign new current value to logical tile
        tile.current = talkId;

        //update visual tiles
        //tiles is the visual tiles, tiles2 are the logical tiles
        tiles[i].innerHTML = tile.text;
        tiles[i].setAttribute("submissionId", tile.submissionId)
        if(tile.isInSchedule){
          tiles[i].innerHTML += " In Schedule";
        }
        else{
          tiles[i].innerHTML += " Not In Schedule";
        }
        
        //Code to update highlighted crumb
        //Get this tile's crumbs
        var crumbs = $('#'+tileId).parent().children('.circle');

        //Highlight current
        //crumbs[talkId].classList.remove('circle');
        //crumbs[talkId].classList.toggle('circle_selected');

        for(var j =0; j<crumbs.length;j++){
          if(talkId != j)
          crumbs[j].style.backgroundColor = 'gray';
          else{
          crumbs[talkId].style.backgroundColor = 'white';

          }

        }

        }
      }


    };

    //function called after we iterate through all session events
    function doneTile(tileId,index){
      tile = tiles2[index];
      tile.reset();
      tiles[index].innerHTML = tile.text;
      tiles[index].setAttribute("submissionId", tile.submissionId)
      tiles[index].setAttribute("total", tile.total)

      //remove breadcrumbs
      $('#'+tileId).parent().children('div').remove('.circle');

      //gray details button again
      var $details = $("#" + tileId).parent().parent().parent().parent().find('.details-btn');
      $details.css("opacity","0.1");
      }

    //Function triggered by the server every X milliseconds
    socket.on('tick', function(count) {
        console.log("tick");
        console.log(count);
        if(!count.isEmpty)
         {
          for(var id in count)
          {
             updateSubmissions(id, count[id]);
             console.log("Called update for id: " +  id);

            for(var i = 0; i<tiles.length;i++)
            {
              if(id == tiles[i].getAttribute("id"))
              {
                $('#'+id).fadeTo(250, 0.5, function() {
                  // Animation complete.
                 });
                $('#'+id).fadeTo(250, 1, function() {
                  // Animation complete.
                 });
              }
            }
          }
         }

      // if(!timer)
      //   createTimer();
      // else{
      //   timer.reset()
      // }
      
      // if($("#" + count[id]).html() != "Select a keyword"){  
      //      var $details = $(this).parent().parent().parent().parent().find('.details-btn');
      //     $details.css("opacity","1");
      // }
    
    });

    $(".tile").on("vclick", function(){
        var submissionId = mapId($(this).attr("submissionid"));
        var isInSchedule = $(this).attr("isInSchedule");
        var tileId = $(this).attr("id");

        if (isInSchedule) {
             NativeBridge.call('removeFromSchedule',submissionId,thisiscallback);
             updateTile(tileId,true);
        }
        else{
             NativeBridge.call('addToSchedule',submissionId,thisiscallback);
             updateTile(tileId,false);
        };
    });

    function updateTile(id, status){
      for(var i =0; i< tiles2.length; i++){
        if(tiles2[i].id == id){
          tiles2[i].isInSchedule = status;
        }
      }
    };
    function mapId(id){
        id = id.replace(/pn/,"chi")
            .replace(/crs/,"cr")
            .replace(/tochi/,"to")
            .replace(/case/,"cs")
            .replace(/pan/,"pl")
            .replace(/sig/,"si")
            .replace(/alt/,"alt");
        return id;
    }

    //Function called after a new filter is posted to server
    //Populates arrays with all titles for each filter
      socket.on('tilesUpdated', function(data) {
          loadData();
    });

    socket.on('doneTile', function(data) { 
      if(onsync)
      {
        for(var i = 0; i<tiles2.length;i++)
        {
          if(data.tileId == tiles2[i].id)
          { 
            doneTile(data.tileId, i);
          }
        }
      }
      else{
        missed.push(data.tileId);
      }       
    });


    loadData();
    });
  </script>

  <div data-role="header" data-position="fixed">
    <h1>Tap to Add</h1>
  </div>
 
  <div id ="main_grid" data-role="content"> 
    <div  class="ui-grid-a">
      <div id="A" class="ui-block-a tile green"><a href="#tiles" data-transition="slide">Interactivity</a></div>
      <div id="B" class="ui-block-b tile green"><a href="#tiles" data-transition="slide">...</a> </div>
      <div id="C" class="ui-block-a tile blue"><a href="#tiles" data-transition="slide">...</a></div>
      <div id="D" class="ui-block-b tile blue"><a href="#tiles" data-transition="slide">...</a></div>
      <div id="E" class="ui-block-a tile red"><a href="#tiles" data-transition="slide">...</a></div>
      <div id="F" class="ui-block-b tile red"><a href="#tiles" data-transition="slide">...</a></div>
      <div id="G" class="ui-block-a tile purple"><a href="#tiles" data-transition="slide">...</a></div>
      <div id="H" class="ui-block-b tile purple"><a href="#tiles" data-transition="slide">...</a></div>
    </div>
  </div>
</div>
 
</body>
</html>